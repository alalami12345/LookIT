<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LookIt // Global (RTDB)</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f0f16;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #6C63FF;
            --accent: #00f2c3;
            --danger: #ff4757;
            --warning: #ffa502;
            --text: #ffffff;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #2a2a3e 0%, #0f0f16 70%);
            min-height: 100vh;
        }

        /* --- 3D / Glass UI --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 90vh;
            position: relative;
        }

        h1, h2, h3 { letter-spacing: -1px; margin-top: 0; }
        h1 { 
            font-size: 3rem; 
            background: linear-gradient(90deg, var(--primary), var(--accent)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            cursor: pointer;
        }

        /* --- Inputs & Buttons --- */
        input, select, textarea {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 10px;
            font-family: inherit;
            outline: none;
            resize: vertical;
        }
        input:focus, textarea:focus { border-color: var(--primary); transform: translateY(-2px); }

        button {
            cursor: pointer;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
        }
        button:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(108, 99, 255, 0.5); }
        button.secondary { background: transparent; border: 1px solid var(--glass-border); box-shadow: none; }
        button.danger { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        button.google-btn { background: white; color: #333; margin-top: 10px; width: 100%; }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.5s ease forwards; }
        .view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .dash-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media(max-width: 900px) { .dash-grid { grid-template-columns: 1fr; } }

        .set-card {
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .set-card:hover { border-color: var(--accent); background: rgba(255,255,255,0.08); }
        .set-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--accent); transform: scaleY(0); transition: 0.3s;
        }
        .set-card:hover::before { transform: scaleY(1); }

        /* --- Search Bar --- */
        .search-wrapper { position: relative; margin-bottom: 20px; }
        .search-wrapper input { padding-left: 40px; font-size: 1.1rem; background: rgba(255,255,255,0.05); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* --- Game UI --- */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .stat-pill { background: rgba(0,0,0,0.4); padding: 8px 20px; border-radius: 50px; font-weight: bold; border: 1px solid var(--glass-border); }

        .question-box {
            text-align: center; padding: 40px; margin-bottom: 30px; font-size: 1.5rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
        }

        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .answer-btn {
            height: 80px; font-size: 1.2rem; background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
        }
        .answer-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        
        .mode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .mode-card { padding: 15px; text-align: left; cursor: pointer; border: 1px solid transparent; }
        .mode-card:hover { border-color: var(--primary); background: rgba(108, 99, 255, 0.1); }
        .mode-card h4 { margin: 0 0 5px 0; color: var(--accent); }
        .mode-card small { opacity: 0.7; font-size: 0.8rem; }

        /* --- Builder Styles --- */
        .q-block { position: relative; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 10px; border-radius: 8px; background: rgba(0,0,0,0.2); }
        .q-remove { position: absolute; top: 5px; right: 10px; color: var(--danger); cursor: pointer; font-size: 1.2rem; }
        
        /* --- Loading --- */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Full Screen Loader -->
    <div id="loader"><div class="spinner"></div></div>

    <div class="container">
        
        <!-- Navbar -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0;">
            <h1 onclick="Nav.to('view-dashboard')">LookIt</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="user-status" class="glass-panel" style="padding: 8px 16px; font-size: 0.9rem; display:none; cursor: pointer;" onclick="Nav.to('view-settings')">
                    Guest
                </div>
            </div>
        </div>

        <!-- VIEW: Auth -->
        <div id="view-auth" class="view active">
            <div class="glass-panel" style="max-width: 400px; margin: 50px auto; padding: 40px;">
                <h2>Enter the Grid</h2>
                <p style="opacity: 0.7">Log in to sync your global sets.</p>
                
                <input type="text" id="username" placeholder="Username (Required for Sign Up)">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Password">
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="Auth.handle('login')" style="flex:1;">Login</button>
                    <button onclick="Auth.handle('register')" class="secondary" style="flex:1;">Sign Up</button>
                </div>
                <button onclick="Auth.googleLogin()" class="google-btn">
                    <span style="font-size:1.2em; vertical-align:sub;">G</span> Continue with Google
                </button>
                <div id="auth-msg" style="margin-top: 15px; color: var(--danger); font-size: 0.9rem;"></div>
            </div>
        </div>

        <!-- VIEW: Dashboard -->
        <div id="view-dashboard" class="view">
            <div class="dash-grid">
                <!-- Left: Create -->
                <div class="glass-panel" style="padding: 20px; height: fit-content; max-height: 85vh; overflow-y: auto;">
                    <h3>Create Set</h3>
                    <input type="text" id="new-set-title" placeholder="Set Title (e.g. Math Ch 1)">
                    <hr style="border-color: var(--glass-border); margin: 20px 0;">
                    
                    <div id="builder-area">
                        <!-- Builder inputs injected here -->
                    </div>
                    
                    <button onclick="Builder.addInput()" class="secondary" style="width:100%; margin-bottom: 10px;">+ Add Question</button>
                    <button onclick="Builder.save()" style="width:100%;">Publish Global</button>
                </div>

                <!-- Right: Browser -->
                <div>
                    <div class="glass-panel" style="padding: 20px; margin-bottom: 20px; display: flex; align-items: center;">
                        <div class="search-wrapper" style="margin:0; flex-grow: 1;">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="search-bar" placeholder="Search global sets..." onkeyup="Dash.filterSets()">
                        </div>
                    </div>

                    <div id="sets-list">
                        <!-- Sets injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Lobby -->
        <div id="view-lobby" class="view">
            <button onclick="Nav.to('view-dashboard')" class="secondary">‚Üê Back</button>
            <div class="glass-panel" style="max-width: 800px; margin: 40px auto; padding: 40px; text-align: center;">
                <h2 id="lobby-title">Ready?</h2>
                <p>Select your Game Mode</p>
                
                <div class="mode-grid">
                    <div class="mode-card glass-panel" onclick="Game.start(0)">
                        <h4>Classic</h4><small>Standard rules. No gimmicks.</small>
                    </div>
                    <div class="mode-card glass-panel" onclick="Game.start(1)">
                        <h4>Hustle</h4><small>Double points, 2x faster time.</small>
                    </div>
                    <div class="mode-card glass-panel" onclick="Game.start(2)">
                        <h4 style="color:var(--danger)">Glitch</h4><small>Wrong answers lose points.</small>
                    </div>
                    <div class="mode-card glass-panel" onclick="Game.start(3)">
                        <h4 style="color:var(--accent)">Zen</h4><small>No timer. Infinite play.</small>
                    </div>
                    <div class="mode-card glass-panel" onclick="Game.start(4)">
                        <h4 style="color:var(--warning)">Gold Rush</h4><small>Money x5, Costs x5.</small>
                    </div>
                    <div class="mode-card glass-panel" onclick="Game.start(5)">
                        <h4 style="color:#d63031">Boss Battle</h4><small>Beat the CPU score.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Settings -->
        <div id="view-settings" class="view">
            <button onclick="Nav.to('view-dashboard')" class="secondary">‚Üê Back</button>
            <div class="glass-panel" style="max-width: 400px; margin: 40px auto; padding: 40px;">
                <h2>Account Settings</h2>
                <label>Display Name</label>
                <input type="text" id="settings-name" placeholder="New Username">
                <button onclick="Settings.updateProfile()">Save Changes</button>
                <hr style="border-color: var(--glass-border); margin: 20px 0;">
                <button onclick="Auth.logout()" class="danger" style="width:100%;">Log Out</button>
            </div>
        </div>

        <!-- VIEW: Game -->
        <div id="view-game" class="view">
            <div class="game-header">
                <div class="stat-pill" id="timer-el">60s</div>
                <div class="stat-pill" id="boss-pill" style="display:none; border-color: var(--danger)">Boss: $0</div>
                <div class="stat-pill" style="border-color: var(--accent)">$<span id="score-el">0</span></div>
            </div>

            <div class="glass-panel question-box">
                <div id="q-text">Loading...</div>
            </div>

            <div class="answers-grid" id="options-grid">
                <!-- Options -->
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <div class="glass-panel" style="display: inline-block; padding: 20px;">
                    <h4>Shop</h4>
                    <button onclick="Game.buy('mult')" class="secondary" id="btn-mult">Multiplier ($50)</button>
                    <button onclick="Game.end()" class="danger">End Game</button>
                </div>
            </div>
        </div>

    </div>

<script>
// --- 1. CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyAYmdrA7We0KRKEq8D4wjhGuXqMu9b5Qy4",
    authDomain: "gimkit-105d1.firebaseapp.com",
    databaseURL: "https://gimkit-105d1-default-rtdb.firebaseio.com", 
    projectId: "gimkit-105d1",
    storageBucket: "gimkit-105d1.firebasestorage.app",
    messagingSenderId: "1002583212768",
    appId: "1:1002583212768:web:df5530acf9000d14670685"
};

// Init Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --- 2. STATE ---
const State = {
    user: null,
    sets: [], 
    activeSet: null,
    score: 0,
    bossScore: 0,
    mult: 1,
    mode: 0,
    timer: null,
    bossTimer: null
};

// --- 3. NAVIGATION ---
const Nav = {
    to: (viewId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        if(viewId === 'view-settings' && State.user) {
            document.getElementById('settings-name').value = State.user.displayName || "";
        }
    },
    loader: (show) => {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }
};

// --- 4. AUTHENTICATION ---
const Auth = {
    init: () => {
        auth.onAuthStateChanged(u => {
            Nav.loader(false);
            if(u) {
                State.user = u;
                const displayName = u.displayName || u.email.split('@')[0];
                document.getElementById('user-status').innerText = displayName;
                document.getElementById('user-status').style.display = 'block';
                Nav.to('view-dashboard');
                Dash.loadGlobalSets();
            } else {
                Nav.to('view-auth');
            }
        });
    },
    handle: async (type) => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const uName = document.getElementById('username').value;
        const msg = document.getElementById('auth-msg');
        
        if(!e || !p) return msg.innerText = "Missing email or password.";
        if(type === 'register' && !uName) return msg.innerText = "Username is required for new accounts.";

        try {
            Nav.loader(true);
            if(type === 'login') {
                await auth.signInWithEmailAndPassword(e, p);
            } else {
                const cred = await auth.createUserWithEmailAndPassword(e, p);
                await cred.user.updateProfile({ displayName: uName });
                State.user = cred.user; 
            }
        } catch(err) {
            Nav.loader(false);
            msg.innerText = err.message;
        }
    },
    googleLogin: async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch(e) {
            alert("Google Sign-In Error: " + e.message);
        }
    },
    logout: () => auth.signOut()
};

// --- 5. SETTINGS ---
const Settings = {
    updateProfile: async () => {
        const newName = document.getElementById('settings-name').value;
        if(!newName) return alert("Name cannot be empty");
        
        Nav.loader(true);
        try {
            await State.user.updateProfile({ displayName: newName });
            document.getElementById('user-status').innerText = newName;
            alert("Profile Updated!");
            Nav.to('view-dashboard');
        } catch(e) {
            alert(e.message);
        }
        Nav.loader(false);
    }
};

// --- 6. DASHBOARD ---
const Dash = {
    loadGlobalSets: async () => {
        const list = document.getElementById('sets-list');
        list.innerHTML = '<div style="text-align:center; opacity:0.5">Fetching global data...</div>';
        try {
            const snap = await db.ref('lookit_sets').limitToLast(20).once('value');
            const data = snap.val();
            State.sets = [];
            if (data) {
                State.sets = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                State.sets.reverse();
            }
            Dash.renderSets(State.sets);
        } catch(e) {
            console.error(e);
            list.innerHTML = '<div style="color:var(--danger)">Error: Check Database Rules.</div>';
        }
    },
    renderSets: (data) => {
        const list = document.getElementById('sets-list');
        list.innerHTML = '';
        if(data.length === 0) list.innerHTML = '<div style="text-align:center">No sets found. Create one!</div>';
        
        data.forEach((s, idx) => {
            const card = document.createElement('div');
            card.className = 'set-card glass-panel';
            const authName = s.authorName || (s.authorEmail ? s.authorEmail.split('@')[0] : 'Anon');
            card.innerHTML = `
                <h3>${s.title}</h3>
                <div style="display:flex; justify-content:space-between; opacity:0.7; font-size:0.85rem;">
                    <span>${s.questions.length} Questions</span>
                    <span>By: ${authName}</span>
                </div>
            `;
            card.onclick = () => {
                State.activeSet = s;
                document.getElementById('lobby-title').innerText = `Play: ${s.title}`;
                Nav.to('view-lobby');
            };
            list.appendChild(card);
        });
    },
    filterSets: () => {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const filtered = State.sets.filter(s => s.title.toLowerCase().includes(term));
        Dash.renderSets(filtered);
    }
};

// --- 7. SET BUILDER ---
const Builder = {
    addInput: () => {
        const div = document.createElement('div');
        div.className = 'q-block';
        div.innerHTML = `
            <div class="q-remove" onclick="this.parentElement.remove()">√ó</div>
            <input placeholder="Question Text" class="b-q" style="font-weight:bold;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="font-size:0.8em; color:var(--accent)">Correct Answers (1 per line)</label>
                    <textarea class="b-c" rows="3" placeholder="e.g.&#10;Paris&#10;paris&#10;PARIS" style="border-color:var(--accent)"></textarea>
                </div>
                <div>
                    <label style="font-size:0.8em; color:var(--danger)">Wrong Answers (1 per line)</label>
                    <textarea class="b-w" rows="3" placeholder="e.g.&#10;London&#10;Berlin&#10;Rome"></textarea>
                </div>
            </div>
        `;
        document.getElementById('builder-area').appendChild(div);
    },
    save: async () => {
        const title = document.getElementById('new-set-title').value;
        const blocks = document.querySelectorAll('#builder-area > .q-block');
        
        if(!title || blocks.length === 0) return alert("Fill out title and at least 1 question.");
        
        Nav.loader(true);
        const questions = [];
        blocks.forEach(b => {
            const q = b.querySelector('.b-q').value;
            // Split by newline and filter empty
            const cRaw = b.querySelector('.b-c').value.split('\n').map(s=>s.trim()).filter(s=>s);
            const wRaw = b.querySelector('.b-w').value.split('\n').map(s=>s.trim()).filter(s=>s);
            
            if(q && cRaw.length > 0 && wRaw.length > 0) {
                questions.push({ q, c: cRaw, w: wRaw });
            }
        });

        if(questions.length === 0) {
            Nav.loader(false);
            return alert("Questions must have valid inputs.");
        }

        const authorName = State.user.displayName || State.user.email.split('@')[0];

        await db.ref('lookit_sets').push({
            title,
            questions,
            author: State.user.uid,
            authorEmail: State.user.email,
            authorName: authorName,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        document.getElementById('new-set-title').value = '';
        document.getElementById('builder-area').innerHTML = '';
        Builder.addInput(); 
        await Dash.loadGlobalSets();
        Nav.loader(false);
    }
};

// --- 8. GAME ENGINE ---
const Game = {
    start: (mode) => {
        State.mode = mode;
        State.score = 0;
        State.bossScore = 0;
        State.mult = 1;
        Nav.to('view-game');
        
        // Mode Defaults
        let time = 60;
        if(mode === 1) time = 30; 
        if(mode === 3) time = 999999; // Zen
        if(mode === 5) document.getElementById('boss-pill').style.display = 'block';
        else document.getElementById('boss-pill').style.display = 'none';

        Game.renderUI();
        Game.nextQ();
        
        if(State.timer) clearInterval(State.timer);
        if(State.bossTimer) clearInterval(State.bossTimer);

        State.timer = setInterval(() => {
            time--;
            document.getElementById('timer-el').innerText = (mode === 3 ? '‚àû' : time + 's');
            
            // Boss Logic
            if(mode === 5) {
                State.bossScore += Math.floor(Math.random() * 150); // Boss earns passive income
                document.getElementById('boss-pill').innerText = `Boss: $${State.bossScore}`;
            }

            if(time <= 0) Game.end();
        }, 1000);
    },
    
    nextQ: () => {
        const set = State.activeSet.questions;
        const qData = set[Math.floor(Math.random() * set.length)];
        
        document.getElementById('q-text').innerText = qData.q;
        
        // Handle New Data Structure (Array) vs Old (String)
        // Pick 1 correct from array, 3 wrong from array
        const corrects = Array.isArray(qData.c) ? qData.c : [qData.c];
        const wrongs = Array.isArray(qData.w) ? qData.w : qData.w; // assuming w is always array
        
        const correctAns = corrects[Math.floor(Math.random() * corrects.length)];
        // Shuffle wrongs and pick 3
        const mixedWrongs = wrongs.sort(() => 0.5 - Math.random()).slice(0, 3);
        
        let answers = [ 
            { txt: correctAns, correct: true }, 
            ...mixedWrongs.map(w => ({ txt: w, correct: false })) 
        ];
        answers.sort(() => Math.random() - 0.5);
        
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        answers.forEach(a => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn glass-panel';
            btn.innerText = a.txt;
            btn.onclick = () => Game.handle(a.correct, btn);
            grid.appendChild(btn);
        });
    },
    
    handle: (correct, btn) => {
        if(correct) {
            btn.style.background = "var(--accent)";
            let gain = 100 * State.mult;
            if(State.mode === 1) gain *= 2; // Hustle
            if(State.mode === 4) gain *= 5; // Gold Rush
            State.score += gain;
            setTimeout(Game.nextQ, 300);
        } else {
            btn.style.background = "var(--danger)";
            if(State.mode === 2) State.score -= 50; // Glitch
            setTimeout(Game.nextQ, 500);
        }
        Game.renderUI();
    },
    
    buy: (type) => {
        if(type === 'mult') {
            let cost = 50 * State.mult;
            if(State.mode === 4) cost *= 5; // Gold Rush Costs
            
            if(State.score >= cost) {
                State.score -= cost;
                State.mult++;
            }
        }
        Game.renderUI();
    },
    
    renderUI: () => {
        document.getElementById('score-el').innerText = State.score;
        let cost = 50 * State.mult;
        if(State.mode === 4) cost *= 5;
        document.getElementById('btn-mult').innerText = `Multiplier x${State.mult} ($${cost})`;
    },
    
    end: () => {
        clearInterval(State.timer);
        let msg = `Game Over!\nFinal Score: $${State.score}`;
        if(State.mode === 5) {
            msg += `\nBoss Score: $${State.bossScore}\nResult: ${State.score > State.bossScore ? "YOU WON!" : "YOU LOST!"}`;
        }
        alert(msg);
        Nav.to('view-dashboard');
    }
};

// Initialize
Builder.addInput();
Auth.init();

</script>
</body>
</html>
