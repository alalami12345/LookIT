

         <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LookIt | Educational Platform</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        :root {
            --bg-dark: #0f0f16;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #6C63FF;
            --accent: #00f2c3;
            --danger: #ff4757;
            --warning: #ffa502;
            --text: #ffffff;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --ai-gradient: linear-gradient(135deg, #6C63FF, #ff4757);
            --correct-green: #2ecc71;
            --wrong-red: #e74c3c;
            --chat-self: #6C63FF;
            --chat-other: #2a2a3e;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #2a2a3e 0%, #0f0f16 70%);
            min-height: 100vh;
        }

        /* --- UI Components --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 90vh; position: relative; }

        h1 { 
            font-size: 3rem; margin: 0;
            background: linear-gradient(90deg, var(--primary), var(--accent)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            cursor: pointer;
        }

        input, select, textarea {
            width: 100%; padding: 15px; margin: 8px 0;
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: white; border-radius: 10px; font-family: inherit; outline: none;
        }
        input:focus { border-color: var(--primary); }

        button {
            cursor: pointer; padding: 12px 24px; border-radius: 10px; border: none;
            font-weight: 700; text-transform: uppercase; background: var(--primary); color: white;
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
        }
        button:hover { transform: translateY(-3px); }
        button.secondary { background: transparent; border: 1px solid var(--glass-border); color: var(--primary); box-shadow: none; }
        button.danger { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        button.google-btn { background: white; color: #333; margin-top: 10px; width: 100%; }
        button.ai-btn { background: var(--ai-gradient); margin-bottom: 10px; width: 100%; }
        
        /* --- Notifications --- */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: #1e1e24; color: white; padding: 15px 25px; border-radius: 12px;
            border-left: 4px solid var(--accent); animation: slideIn 0.3s ease; min-width: 250px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #1e1e24; width: 90%; max-width: 500px; padding: 30px; border-radius: 20px;
            border: 1px solid var(--glass-border); text-align: center;
            position: relative;
        }

        /* --- Chat --- */
        .chat-area {
            display: flex; flex-direction: column; gap: 10px; padding: 15px;
            overflow-y: auto; height: 100%; scroll-behavior: smooth;
        }
        .chat-msg-wrapper { display: flex; align-items: flex-end; }
        .chat-msg-wrapper.self { justify-content: flex-end; }
        .chat-msg {
            max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
            position: relative; word-wrap: break-word;
        }
        .chat-msg.self { background: var(--chat-self); color: white; border-bottom-right-radius: 4px; }
        .chat-msg.other { background: var(--chat-other); color: #ddd; border-bottom-left-radius: 4px; }
        .chat-user { font-size: 0.7rem; margin-bottom: 2px; opacity: 0.7; display: block; }
        .chat-report-btn { 
            cursor: pointer; margin: 0 5px; color: var(--danger); opacity: 0.5; font-size: 0.8rem;
        }
        .chat-report-btn:hover { opacity: 1; transform: scale(1.1); }
        .report-count-badge { background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 8px; margin-left: 5px; }

        /* --- Game Styles --- */
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .answer-btn { 
            height: 100px; font-size: 1.3rem; background: rgba(255,255,255,0.08); 
            border: 2px solid rgba(255,255,255,0.1); color: white; border-radius: 12px;
        }
        .answer-btn:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); transform: scale(1.02); }
        .answer-btn.correct { background: var(--correct-green) !important; border-color: var(--correct-green) !important; opacity: 1 !important; }
        .answer-btn.wrong { background: var(--wrong-red) !important; border-color: var(--wrong-red) !important; opacity: 0.6; }
        .answer-btn.dim { opacity: 0.3; pointer-events: none; }
        
        /* Game Image */
        #q-image-container img {
            max-height: 300px; max-width: 100%; border-radius: 12px; border: 2px solid var(--glass-border);
            margin-bottom: 20px; box-shadow: var(--shadow); object-fit: contain;
        }

        /* Layouts */
        .view { display: none; animation: fadeIn 0.5s ease forwards; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .dash-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media(max-width: 900px) { .dash-grid { grid-template-columns: 1fr; } }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .set-card { padding: 20px; margin-bottom: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .set-card:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); }
        .friend-item { padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .lobby-code { font-size: 3em; font-weight: 700; color: var(--warning); letter-spacing: 5px; margin: 20px 0; }

        /* Question Count Badge */
        #builder-count { font-size: 0.9rem; color: var(--accent); float: right; }
        
        /* Ban UI */
        .ban-message { 
            text-align: center; padding: 20px; border: 2px solid var(--danger); 
            border-radius: 10px; background: rgba(255, 71, 87, 0.1); 
        }
        .ban-timer { 
            font-size: 2rem; font-weight: 700; color: var(--warning); 
            margin-top: 10px; display: block;
        }
    </style>
</head>
<body>

    <!-- Overlays -->
    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>
    
    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">Confirm</h3>
            <p id="modal-text">Are you sure?</p>
            
            <!-- Dynamic: Input for Deletion -->
            <div id="modal-input-container" style="display:none; margin: 15px 0;">
                <input type="text" id="modal-input" placeholder="Type here..." style="text-align:center; font-weight:bold;">
            </div>

            <!-- Dynamic: AI Explanation Area -->
            <div id="modal-ai-content" style="display:none; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin:15px 0; text-align:left; font-size:0.9rem; border-left: 3px solid var(--primary);">
                Loading AI Analysis...
            </div>

            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button id="modal-yes" class="primary">Yes</button>
                <button id="modal-no" class="secondary">No</button>
            </div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="sfx-correct" src="./correct-choice-43861.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="./error-mistake-sound-effect-incorrect-answer-437420.mp3" preload="auto"></audio>

    <div class="container">
        
        <!-- Navbar -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0;">
            <h1 onclick="Nav.to('view-dashboard')">LookIt</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="nav-mp-btn" class="secondary" style="padding: 8px 16px; font-size:0.8rem;" onclick="Nav.to('view-multiplayer-select')">Host/Join</button>
                <div id="user-status" class="glass-panel" style="padding: 8px 16px; font-size: 0.9rem; display:none; cursor: pointer;" onclick="Nav.to('view-settings')">Guest</div>
            </div>
        </div>

        <!-- VIEW: Auth -->
        <div id="view-auth" class="view active">
            <div class="glass-panel" style="max-width: 400px; margin: 50px auto; padding: 40px;">
                <h2>Enter the Grid</h2>
                <input type="text" id="username" placeholder="Username (Required for Sign Up)">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Password">
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="Auth.handle('login')" style="flex:1;">Login</button>
                    <button onclick="Auth.handle('register')" class="secondary" style="flex:1;">Sign Up</button>
                </div>
                <button onclick="Auth.googleLogin()" class="google-btn">
                    <span style="font-size:1.2em; vertical-align:sub;">G</span> Continue with Google
                </button>
                <p onclick="Notify.toast('Password reset email sent (Simulated)', 'info')" style="text-align:center; cursor:pointer; opacity:0.6; font-size:0.8rem; margin-top:20px;">Forgot Password?</p>
            </div>
        </div>

        <!-- VIEW: Dashboard -->
        <div id="view-dashboard" class="view">
            <div style="margin-bottom: 20px; display:flex; gap:10px;">
                <button onclick="Nav.switchDash('dash-play')" class="secondary">Play</button>
                <button onclick="Nav.switchDash('dash-create')" class="secondary">Create</button>
                <button onclick="Nav.switchDash('dash-social')" class="secondary" style="border-color: var(--accent); color: var(--accent);">Social</button>
            </div>

            <div class="dash-grid">
                <div id="dash-content" style="grid-column: 1 / -1;"></div>
            </div>
        </div>

        <!-- TEMPLATES -->
        <div id="tpl-play" style="display:none;">
            <div class="search-wrapper" style="margin-bottom:20px;">
                <input type="text" id="search-bar" placeholder="Search sets..." onkeyup="Dash.filterSets()">
            </div>
            <div id="sets-list"></div>
        </div>

        <div id="tpl-create" style="display:none;">
            <div class="dash-grid">
                <div class="glass-panel" style="padding: 20px;">
                    <h3>Create Set <span id="builder-count">Questions: 0</span></h3>
                    <input type="text" id="new-set-title" placeholder="Set Title">
                    <hr style="border-color: var(--glass-border); margin: 20px 0;">
                    <div id="builder-area"></div>
                    <button onclick="Builder.addInput()" class="secondary" style="width:100%; margin-bottom: 10px;">+ Add Question</button>
                    <button onclick="Builder.aiSentinel()" class="ai-btn">‚ú® AI Sentinel Audit (Required)</button>
                    <button onclick="Builder.save()" style="width:100%;">Publish</button>
                </div>
            </div>
        </div>

        <div id="tpl-social" style="display:none;">
            <div class="dash-grid">
                <div class="glass-panel" style="padding: 20px;">
                    <h3>Friends</h3>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="friend-search" placeholder="Exact Username...">
                        <button onclick="Social.sendRequest()">+</button>
                    </div>
                    <h4 style="color:var(--warning)">Requests</h4>
                    <div id="friend-requests-list"></div>
                    <h4 style="color:var(--accent)">Friends</h4>
                    <div id="friends-list"></div>
                </div>
                <div class="glass-panel" style="padding: 20px; height:500px; display:flex; flex-direction:column;">
                    <h3>Global Chat</h3>
                    <div id="global-chat-box" class="chat-area" style="flex-grow:1; margin-bottom:10px; background:rgba(0,0,0,0.2); border-radius:10px;"></div>
                    <div id="chat-input-container">
                        <!-- Chat input or Ban message is rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Multiplayer Select -->
        <div id="view-multiplayer-select" class="view">
            <button onclick="Nav.to('view-dashboard')" class="secondary">‚Üê Back</button>
            <div class="glass-panel" style="max-width: 600px; margin: 40px auto; padding: 40px; text-align: center;">
                <h2>Multiplayer Portal</h2>
                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button onclick="Multiplayer.hostSelect()" style="flex:1; background: var(--accent);">HOST GAME</button>
                    <button onclick="Multiplayer.joinShow()" style="flex:1;">JOIN GAME</button>
                </div>
                <div id="join-section" style="margin-top: 20px; display: none;">
                    <input type="text" id="join-code" placeholder="Enter 4-digit code">
                    <button onclick="Multiplayer.joinGame()" style="width: 100%;">GO</button>
                </div>
            </div>
        </div>

        <!-- VIEW: Host Lobby -->
        <div id="view-host-lobby" class="view">
            <button onclick="Nav.to('view-dashboard')" class="danger">‚Üê Leave</button>
            <div class="glass-panel" style="max-width: 800px; margin: 20px auto; padding: 30px; text-align:center;">
                <h2>Lobby Code</h2>
                <div class="lobby-code" id="lobby-code-display">...</div>
                <p id="lobby-status">Waiting for players...</p>
                <div id="lobby-player-list" style="margin:20px 0;"></div>
                <button onclick="Multiplayer.hostStartGame()" style="width:100%; font-size:1.2rem;">START GAME</button>
            </div>
        </div>

        <!-- VIEW: Single Player Lobby -->
        <div id="view-lobby" class="view">
            <button onclick="Nav.to('view-dashboard')" class="secondary">‚Üê Back</button>
            <div class="glass-panel" style="max-width: 800px; margin: 40px auto; padding: 40px; text-align: center;">
                <h2 id="lobby-title">Single Player</h2>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap:10px; margin-top:20px;">
                    <div class="glass-panel" style="padding:15px; cursor:pointer;" onclick="Game.startSingle(0)">Classic</div>
                    <div class="glass-panel" style="padding:15px; cursor:pointer;" onclick="Game.startSingle(1)">Hustle (2x)</div>
                    <div class="glass-panel" style="padding:15px; cursor:pointer; border-color:var(--danger);" onclick="Game.startSingle(2)">Glitch</div>
                    <div class="glass-panel" style="padding:15px; cursor:pointer; border-color:var(--warning);" onclick="Game.startSingle(4)">Gold Rush</div>
                </div>
            </div>
        </div>

        <!-- VIEW: Game Active -->
        <div id="view-game" class="view">
            <button onclick="Game.endSingle(true)" class="danger">Quit</button>
            <div style="display:flex; justify-content:space-between; margin:20px 0; font-size:1.5rem; font-weight:bold;">
                <div class="stat-pill" style="color:var(--accent)">$<span id="score-el">0</span></div>
                <div class="stat-pill" id="timer-el">60s</div>
            </div>
            
            <div class="glass-panel" style="text-align:center; padding:40px; margin-bottom:20px;">
                <!-- Image Container -->
                <div id="q-image-container"></div>
                <div id="q-text" style="font-size:1.8rem; font-weight:500;">Loading...</div>
            </div>

            <div class="answers-grid" id="options-grid"></div>
            
            <div id="ai-helper-btn" style="text-align:center; margin-top:20px; display:none;">
                <button onclick="Game.explainAI()" class="ai-btn">ü§ñ Explain with AI</button>
            </div>
        </div>

        <!-- VIEW: Settings -->
        <div id="view-settings" class="view">
            <button onclick="Nav.to('view-dashboard')" class="secondary">‚Üê Back</button>
            <div class="glass-panel" style="max-width: 400px; margin: 40px auto; padding: 40px;">
                <h2>Settings</h2>
                <label>Display Name</label>
                <input type="text" id="settings-name">
                <button onclick="Settings.updateProfile()">Save</button>
                <hr style="border-color: var(--glass-border); margin: 20px 0;">
                <button onclick="Auth.logout()" class="secondary" style="width:100%; margin-bottom:10px;">Log Out</button>
                <button onclick="Settings.deleteAccount()" class="danger" style="width:100%;">Delete Account</button>
            </div>
        </div>

    </div>

<script>
// --- CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyAYmdrA7We0KRKEq8D4wjhGuXqMu9b5Qy4",
    authDomain: "gimkit-105d1.firebaseapp.com",
    databaseURL: "https://gimkit-105d1-default-rtdb.firebaseio.com", 
    projectId: "gimkit-105d1",
    storageBucket: "gimkit-105d1.firebasestorage.app",
    messagingSenderId: "1002583212768",
    appId: "1:1002583212768:web:df5530acf9000d14670685"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --- STATE ---
const State = {
    user: null,
    sets: [],
    activeSet: null,
    score: 0,
    mode: 0,
    timer: null,
    chatListener: null,
    aiChecked: false,
    currentQData: null, 
    lobbyId: null,
    mpListener: null,
    isBanned: false,
    banTimerInterval: null,
};

// --- NOTIFICATIONS ---
const Notify = {
    toast: (msg, type='info') => {
        const con = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast';
        el.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--accent)';
        el.innerText = msg;
        con.appendChild(el);
        setTimeout(() => el.remove(), 3000);
    },
    confirm: (msg, onYes, onNo) => {
        const modal = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = "Game Over";
        document.getElementById('modal-text').innerText = msg;
        document.getElementById('modal-yes').innerText = "Replay";
        document.getElementById('modal-no').innerText = "Exit";
        document.getElementById('modal-input-container').style.display = 'none'; 
        document.getElementById('modal-ai-content').style.display = 'none';
        modal.style.display = 'flex';
        document.getElementById('modal-yes').onclick = () => { modal.style.display = 'none'; if(onYes) onYes(); };
        document.getElementById('modal-no').onclick = () => { modal.style.display = 'none'; if(onNo) onNo(); };
    },
    prompt: (msg, matchText, onMatch) => {
        const modal = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = "Strict Action";
        document.getElementById('modal-text').innerHTML = `${msg}<br>Type "<b>${matchText}</b>"`;
        document.getElementById('modal-yes').innerText = "Confirm";
        document.getElementById('modal-no').innerText = "Cancel";
        document.getElementById('modal-ai-content').style.display = 'none';
        const inputDiv = document.getElementById('modal-input-container');
        const input = document.getElementById('modal-input');
        inputDiv.style.display = 'block';
        input.value = '';
        modal.style.display = 'flex';
        document.getElementById('modal-yes').onclick = () => {
            if(input.value === matchText) { modal.style.display = 'none'; onMatch(); } 
            else Notify.toast("Mismatch!", "error");
        };
        document.getElementById('modal-no').onclick = () => modal.style.display = 'none';
    },
    aiModal: (qText, correctAns) => {
        const modal = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = "AI Analysis";
        document.getElementById('modal-text').innerText = "Thinking...";
        document.getElementById('modal-yes').innerText = "Close";
        document.getElementById('modal-no').style.display = 'none';
        document.getElementById('modal-input-container').style.display = 'none';
        const content = document.getElementById('modal-ai-content');
        content.style.display = 'block';
        content.innerHTML = `<span style="opacity:0.7">Generating explanation...</span>`;
        modal.style.display = 'flex';
        setTimeout(() => {
            document.getElementById('modal-text').innerText = "Analysis Complete";
            content.innerHTML = `<strong>Question:</strong> ${qText}<br><br><strong>Correct Answer:</strong> <span style="color:var(--accent)">${correctAns}</span><br><br><strong>Reasoning:</strong> The selected answer was incorrect based on the dataset logic. "${correctAns}" fits the context of the query perfectly.`;
        }, 1500);
        document.getElementById('modal-yes').onclick = () => {
            modal.style.display = 'none';
            document.getElementById('modal-no').style.display = 'inline-block';
        };
    },
    welcome: (username) => {
        const modal = document.getElementById('modal-overlay');
        document.getElementById('modal-title').innerText = `Welcome, ${username}!`;
        document.getElementById('modal-text').innerHTML = "Welcome to LookIt!<br>Create sets, host games, and play.";
        document.getElementById('modal-yes').innerText = "Let's Go!";
        document.getElementById('modal-no').style.display = 'none';
        document.getElementById('modal-input-container').style.display = 'none';
        document.getElementById('modal-ai-content').style.display = 'none';
        modal.style.display = 'flex';
        document.getElementById('modal-yes').onclick = () => {
            modal.style.display = 'none';
            document.getElementById('modal-no').style.display = 'inline-block';
        };
    },
    playAudio: (type) => {
        const id = type === 'correct' ? 'sfx-correct' : 'sfx-wrong';
        const aud = document.getElementById(id);
        if(aud) { aud.currentTime = 0; aud.play().catch(e=>{}); }
    }
};

// --- NAVIGATION ---
const Nav = {
    to: (viewId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-dashboard' && !document.getElementById('dash-content').innerHTML.trim()) Nav.switchDash('dash-play');
    },
    switchDash: (contentId) => {
        const content = document.getElementById('dash-content');
        if(contentId === 'dash-create') {
            content.innerHTML = document.getElementById('tpl-create').innerHTML;
            Builder.addInput();
            State.aiChecked = false;
        } else if(contentId === 'dash-play') {
            content.innerHTML = document.getElementById('tpl-play').innerHTML;
            Dash.loadGlobalSets();
        } else if(contentId === 'dash-social') {
            content.innerHTML = document.getElementById('tpl-social').innerHTML;
            Social.loadSocials();
            Social.checkBanStatus(); // MANDATORY check on entering social tab
        }
    },
    loader: (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none'
};

// --- AUTH ---
const Auth = {
    init: () => {
        auth.onAuthStateChanged(async u => {
            Nav.loader(false);
            if(u) {
                State.user = u;
                document.getElementById('user-status').innerText = u.displayName || "User";
                document.getElementById('user-status').style.display = 'block';
                document.getElementById('nav-mp-btn').style.display = 'block';
                db.ref(`users/${u.uid}`).update({ username: u.displayName, email: u.email });
                Nav.to('view-dashboard');
            } else {
                document.getElementById('user-status').style.display = 'none';
                document.getElementById('nav-mp-btn').style.display = 'none';
                Nav.to('view-auth');
            }
        });
    },
    handle: async (type) => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const uName = document.getElementById('username').value;
        if(!e || !p) return Notify.toast("Credentials missing", "error");
        Nav.loader(true);
        try {
            if(type === 'login') {
                await auth.signInWithEmailAndPassword(e, p);
            } else {
                const cred = await auth.createUserWithEmailAndPassword(e, p);
                await cred.user.updateProfile({ displayName: uName });
                State.user = cred.user;
                Notify.welcome(uName);
            }
            Notify.toast("Success", "success");
        } catch(err) { Nav.loader(false); Notify.toast(err.message, "error"); }
    },
    googleLogin: async () => {
        try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
        catch(e) { Notify.toast(e.message, "error"); }
    },
    logout: () => auth.signOut()
};

// --- SETTINGS ---
const Settings = {
    updateProfile: async () => {
        const name = document.getElementById('settings-name').value;
        if(!name) return;
        try {
            await State.user.updateProfile({ displayName: name });
            await db.ref(`users/${State.user.uid}`).update({ username: name });
            Notify.toast("Updated", "success");
        } catch(e) { Notify.toast(e.message, "error"); }
    },
    deleteAccount: () => {
        Notify.prompt("Delete Account?", State.user.displayName, () => {
            Nav.loader(true);
            db.ref(`users/${State.user.uid}`).remove().then(() => State.user.delete().then(() => location.reload()));
        });
    }
};

// --- SOCIAL / CHAT LOCKDOWN ---
const Social = {
    BAN_DURATION_MS: 7 * 24 * 60 * 60 * 1000, // 7 days in milliseconds
    REPORT_THRESHOLD: 10,
    BANNED_WORDS: ['stupid', 'hate', 'kill', 'nazi', 'racist', 'sex', 'asshole', 'bitch', 'crap', 'damn', 'dick', 'fuck', 'hell', 'motherfucker', 'piss', 'shit', 'wanker'],

    loadSocials: () => {
        if(!State.user) return;
        db.ref(`users/${State.user.uid}/requests`).on('value', snap => {
            const div = document.getElementById('friend-requests-list');
            if(div) { div.innerHTML = ''; snap.forEach(s => {
                const req = s.val();
                div.innerHTML += `<div class="friend-item"><span>${req.fromName}</span><button onclick="Social.respond('${s.key}','${req.fromUid}','${req.fromName}',true)">‚úì</button></div>`;
            });}
        });
        db.ref(`users/${State.user.uid}/friends`).on('value', snap => {
            const div = document.getElementById('friends-list');
            if(div) { div.innerHTML = ''; snap.forEach(s => div.innerHTML += `<div class="friend-item" style="color:var(--accent)">‚óè ${s.val().username}</div>`); }
        });
        Social.initChat();
    },

    // 1. Check ban status and render UI accordingly
    checkBanStatus: async () => {
        if (!State.user) return;

        const banRef = db.ref(`bans/${State.user.uid}`);
        const snap = await banRef.once('value');
        const now = Date.now();
        const inputCon = document.getElementById('chat-input-container');

        if (snap.exists()) {
            const banEnd = snap.val().timestamp;
            if (banEnd > now) {
                State.isBanned = true;
                Social.renderChatInput(true, banEnd);
                return;
            } else {
                // Ban expired, remove the ban record
                await banRef.remove();
            }
        }
        
        State.isBanned = false;
        Social.renderChatInput(false);
    },

    // Renders the chat input area based on ban status
    renderChatInput: (isBanned, banEnd) => {
        const inputCon = document.getElementById('chat-input-container');
        if (!inputCon) return;

        if (State.banTimerInterval) clearInterval(State.banTimerInterval);
        inputCon.innerHTML = '';

        if (isBanned) {
            // Display ban message and timer
            const updateTimer = () => {
                const now = Date.now();
                const remaining = banEnd - now;
                if (remaining <= 0) {
                    clearInterval(State.banTimerInterval);
                    Social.checkBanStatus(); // Unban and re-render
                    Notify.toast("You are unbanned! Chat is restored.", "success");
                    return;
                }
                const d = Math.floor(remaining / (1000 * 60 * 60 * 24));
                const h = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((remaining % (1000 * 60)) / 1000);

                inputCon.innerHTML = `
                    <div class="ban-message">
                        <i class="fas fa-hammer" style="color:var(--danger)"></i> Chat Banned!
                        <span class="ban-timer">${d}d ${h}h ${m}m ${s}s</span>
                        <small style="opacity:0.7">Violation of Strict Filter detected. Wait for ban lift.</small>
                    </div>
                `;
            };
            updateTimer();
            State.banTimerInterval = setInterval(updateTimer, 1000);

        } else {
            // Display normal chat input
            inputCon.innerHTML = `
                <div style="display:flex; gap:10px;">
                    <input type="text" id="chat-input" placeholder="Message..." onkeypress="if(event.key==='Enter') Social.sendChat()">
                    <button onclick="Social.sendChat()">Send</button>
                </div>
            `;
        }
    },

    // 2. Chat initialization, now with reporting mechanism
    initChat: () => {
        const box = document.getElementById('global-chat-box');
        if(!box) return;
        if(State.chatListener) db.ref('global_chat').off();
        
        // We attach the listener regardless of ban status to see incoming messages
        State.chatListener = db.ref('global_chat').limitToLast(50).on('child_added', snap => {
            const m = snap.val();
            const msgKey = snap.key;
            const isMe = m.uid === State.user.uid;
            
            const divWrapper = document.createElement('div');
            divWrapper.className = `chat-msg-wrapper ${isMe ? 'self' : 'other'}`;
            
            const div = document.createElement('div');
            div.className = `chat-msg ${isMe ? 'self' : 'other'}`;
            div.innerHTML = `<span class="chat-user">${m.user}</span>${m.text}`;

            let reportHtml = '';
            if (!isMe) {
                // Show report button for other users' messages
                const reportCount = m.reports ? Object.keys(m.reports).length : 0;
                reportHtml = `
                    <i class="fas fa-flag chat-report-btn" title="Report message" onclick="Social.reportMessage('${msgKey}', '${m.uid}')"></i>
                    <span class="report-count-badge">${reportCount}</span>
                `;
                divWrapper.innerHTML = reportHtml;
            }

            divWrapper.appendChild(div);
            if (!isMe) divWrapper.innerHTML += reportHtml; else divWrapper.appendChild(div);

            box.appendChild(divWrapper);
            box.scrollTop = box.scrollHeight;
        });
    },

    // 3. Send message with self-ban filter
    sendChat: async () => {
        if (State.isBanned) return Notify.toast("You are currently banned from chat.", "error");

        const inp = document.getElementById('chat-input');
        const rawText = inp.value;
        if(!rawText.trim()) return;

        const lowerText = rawText.toLowerCase();

        // Check for self-ban violation
        const violatedWord = Social.BANNED_WORDS.find(word => lowerText.includes(word));
        
        if (violatedWord) {
            const banEnd = Date.now() + Social.BAN_DURATION_MS;
            await db.ref(`bans/${State.user.uid}`).set({ timestamp: banEnd, reason: `Used prohibited word: ${violatedWord}` });
            inp.value = '';
            Social.checkBanStatus(); // Activates the ban UI
            Notify.toast("CRITICAL VIOLATION! BANNED FOR 7 DAYS.", "error");
            return;
        }

        // Clean text (typo correction simulation - capitalizing start)
        const cleanedText = rawText.charAt(0).toUpperCase() + rawText.slice(1);

        db.ref('global_chat').push({ 
            uid: State.user.uid,
            user: State.user.displayName, 
            text: cleanedText, 
            ts: firebase.database.ServerValue.TIMESTAMP 
        });
        inp.value = '';
    },

    // 4. Reporting logic
    reportMessage: async (msgKey, senderUid) => {
        if (!State.user || State.user.uid === senderUid) return;
        
        const reporterUid = State.user.uid;
        const msgRef = db.ref(`global_chat/${msgKey}`);

        try {
            // Use a transaction to safely update reports and check the threshold
            const result = await msgRef.transaction(currentData => {
                if (currentData === null) return currentData; // Message already deleted/banned

                if (!currentData.reports) currentData.reports = {};
                
                // Prevent duplicate reports from the same user
                if (currentData.reports[reporterUid]) {
                    Notify.toast("You already reported this message.", "info");
                    return; // Abort transaction
                }

                currentData.reports[reporterUid] = true;
                const reportCount = Object.keys(currentData.reports).length;

                if (reportCount >= Social.REPORT_THRESHOLD) {
                    // Trigger BAN!
                    const banEnd = Date.now() + Social.BAN_DURATION_MS;
                    db.ref(`bans/${senderUid}`).set({ timestamp: banEnd, reason: "10 Community Reports" });
                    
                    // Mark for deletion/remove the message from chat
                    return null; 
                }
                
                return currentData;
            });

            if (result && result.committed) {
                if (result.snapshot.val() === null) {
                    Notify.toast("Player banned and message removed!", "error");
                } else {
                    Notify.toast("Message reported. Current reports: " + Object.keys(result.snapshot.val().reports).length, "warning");
                }
            }
        } catch(e) {
            Notify.toast("Error reporting message.", "error");
            console.error(e);
        }
    },
    
    // Other social functions (unchanged)
    respond: async (key, uid, name, accept) => {
        await db.ref(`users/${State.user.uid}/requests/${key}`).remove();
        if(accept) {
            await db.ref(`users/${State.user.uid}/friends`).push({ uid, username: name });
            await db.ref(`users/${uid}/friends`).push({ uid: State.user.uid, username: State.user.displayName });
        }
    },
    sendRequest: async () => {
        const name = document.getElementById('friend-search').value;
        const snap = await db.ref('users').orderByChild('username').equalTo(name).once('value');
        if(snap.exists()) {
            const uid = Object.keys(snap.val())[0];
            db.ref(`users/${uid}/requests`).push({ fromUid: State.user.uid, fromName: State.user.displayName });
            Notify.toast("Sent", "success");
        } else Notify.toast("User not found", "error");
    }
};

// --- DASHBOARD ---
const Dash = {
    loadGlobalSets: async () => {
        const list = document.getElementById('sets-list');
        if(!list) return;
        list.innerHTML = '<div style="opacity:0.5">Loading...</div>';
        const snap = await db.ref('lookit_sets').limitToLast(20).once('value');
        State.sets = [];
        if(snap.val()) State.sets = Object.keys(snap.val()).map(k => ({ id: k, ...snap.val()[k] })).reverse();
        Dash.renderSets(State.sets);
    },
    renderSets: (data) => {
        const list = document.getElementById('sets-list');
        if(!list) return;
        list.innerHTML = '';
        data.forEach(s => {
            const div = document.createElement('div');
            div.className = 'set-card glass-panel';
            const delBtn = (State.user && s.author === State.user.uid) ? `<button class="danger" onclick="event.stopPropagation(); Dash.deleteSet('${s.id}', '${s.title}')">DEL</button>` : '';
            div.innerHTML = `<div><h3>${s.title}</h3><span style="opacity:0.7">${s.questions ? s.questions.length : 0} Qs ‚Ä¢ ${s.authorName}</span></div>${delBtn}`;
            div.onclick = () => {
                State.activeSet = s;
                document.getElementById('lobby-title').innerText = s.title;
                Nav.to('view-lobby');
            };
            list.appendChild(div);
        });
    },
    deleteSet: (id, title) => {
        Notify.prompt("Delete Set?", title, async () => {
            await db.ref(`lookit_sets/${id}`).remove();
            Dash.loadGlobalSets();
            Notify.toast("Deleted", "success");
        });
    },
    filterSets: () => {
        const term = document.getElementById('search-bar').value.toLowerCase();
        Dash.renderSets(State.sets.filter(s => s.title.toLowerCase().includes(term)));
    }
};

// --- BUILDER ---
const Builder = {
    updateCount: () => {
        const cnt = document.querySelectorAll('.q-block').length;
        document.getElementById('builder-count').innerText = `Questions: ${cnt}`;
    },
    addInput: () => {
        const area = document.getElementById('builder-area');
        const div = document.createElement('div');
        div.className = 'q-block glass-panel';
        div.style.marginBottom = '10px'; div.style.padding = '15px';
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                <span style="opacity:0.5;font-size:0.8rem;">New Question</span>
                <span style="color:var(--danger);cursor:pointer;" onclick="this.parentElement.parentElement.remove(); Builder.updateCount()">Remove</span>
            </div>
            <input type="text" class="b-img" placeholder="Image URL (Optional)" style="margin-bottom:10px; font-size:0.9rem;">
            <textarea class="b-q" placeholder="Question Text" rows="2" style="font-weight:bold;"></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <textarea class="b-c" placeholder="Correct Answer" rows="2"></textarea>
                <textarea class="b-w" placeholder="Wrong Answer" rows="2"></textarea>
            </div>`;
        area.appendChild(div);
        Builder.updateCount();
    },
    aiSentinel: () => {
        Notify.toast("AI Sentinel Scanning...", "info");
        setTimeout(() => {
            const banned = ['stupid', 'hate', 'kill', 'badword'];
            let violations = 0;
            let fixes = 0;
            const blocks = document.querySelectorAll('.q-block');

            blocks.forEach(b => {
                const q = b.querySelector('.b-q');
                const img = b.querySelector('.b-img');

                // 1. Strict Nuke
                banned.forEach(word => {
                    if(q.value.toLowerCase().includes(word)) violations++;
                });

                // 2. Fix Typos and formatting
                let cleanedValue = q.value;
                if(cleanedValue && cleanedValue[0] !== cleanedValue[0].toUpperCase()) {
                    cleanedValue = cleanedValue.charAt(0).toUpperCase() + cleanedValue.slice(1);
                    fixes++;
                }
                // Fix double spaces
                cleanedValue = cleanedValue.replace(/\s+/g, ' ');
                if (cleanedValue !== q.value) { fixes++; }
                q.value = cleanedValue;


                // 3. Image Check
                if(img.value) {
                    if(!img.value.match(/\.(jpeg|jpg|gif|png)$/) && !img.value.startsWith('http')) {
                        img.style.borderColor = 'var(--warning)';
                    } else {
                        img.style.borderColor = 'var(--accent)';
                    }
                }
            });

            if(violations > 0) {
                document.getElementById('builder-area').innerHTML = '';
                Builder.updateCount();
                Notify.toast("‚ö†Ô∏è VIOLATION DETECTED. SET DELETED BY AI.", "error");
                State.aiChecked = false;
            } else {
                State.aiChecked = true;
                Notify.toast(`Scan Complete. Fixed ${fixes} typos. Images verified.`, "success");
            }
        }, 1200);
    },
    save: async () => {
        if(!State.user) return Notify.toast("Login first", "error");
        if(!State.aiChecked) return Notify.toast("Run AI Sentinel first!", "error");
        const title = document.getElementById('new-set-title').value;
        const qs = [];
        document.querySelectorAll('.q-block').forEach(b => {
            const q = b.querySelector('.b-q').value;
            const img = b.querySelector('.b-img').value;
            const c = b.querySelector('.b-c').value.split('\n').filter(x=>x);
            const w = b.querySelector('.b-w').value.split('\n').filter(x=>x);
            if(q && c.length && w.length) qs.push({q, img, c, w});
        });
        if(!qs.length || !title) return Notify.toast("Invalid Set", "error");
        Nav.loader(true);
        await db.ref('lookit_sets').push({ title, questions: qs, author: State.user.uid, authorName: State.user.displayName });
        Nav.loader(false); Notify.toast("Published", "success");
        Nav.switchDash('dash-play');
    }
};

// --- GAME ENGINE ---
const Game = {
    startSingle: (mode) => {
        if(!State.activeSet) return;
        State.mode = mode; State.score = 0;
        Nav.to('view-game');
        Game.nextQ();
        let t = mode === 1 ? 30 : 60;
        if(State.timer) clearInterval(State.timer);
        State.timer = setInterval(() => {
            t--;
            document.getElementById('timer-el').innerText = t + 's';
            if(t <= 0) Game.endSingle(false);
        }, 1000);
    },
    nextQ: () => {
        const q = State.activeSet.questions[Math.floor(Math.random() * State.activeSet.questions.length)];
        State.currentQData = q;
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('ai-helper-btn').style.display = 'none';
        
        // Handle Image
        const imgCon = document.getElementById('q-image-container');
        imgCon.innerHTML = '';
        if(q.img) {
            const im = document.createElement('img');
            im.src = q.img;
            im.onerror = () => { im.src = 'https://placehold.co/300x200/4B0082/FFFFFF?text=Image+Load+Fail'; }
            imgCon.appendChild(im);
        }

        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        const correct = Array.isArray(q.c) ? q.c : [q.c];
        const wrong = Array.isArray(q.w) ? q.w : [q.w];
        let opts = correct.map(x=>({txt:x, ok:true}));
        wrong.slice(0,3).forEach(x=>opts.push({txt:x, ok:false}));
        opts.sort(()=>Math.random()-0.5);

        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn'; btn.innerText = o.txt;
            btn.dataset.correct = o.ok;
            btn.onclick = () => Game.check(btn, o.ok);
            grid.appendChild(btn);
        });
    },
    check: (btn, isOk) => {
        const allBtns = document.querySelectorAll('.answer-btn');
        allBtns.forEach(b => {
            b.disabled = true;
            if(b.dataset.correct === "true") b.classList.add('correct');
            else b.classList.add('dim');
        });

        if(isOk) {
            Notify.playAudio('correct');
            State.score += (State.mode === 1 ? 200 : 100);
            setTimeout(() => Game.nextQ(), 2000);
        } else {
            Notify.playAudio('wrong');
            btn.classList.remove('dim');
            btn.classList.add('wrong');
            if(State.mode === 2) State.score -= 50;
            document.getElementById('ai-helper-btn').style.display = 'block';
            setTimeout(() => Game.nextQ(), 4000);
        }
        document.getElementById('score-el').innerText = State.score;
    },
    explainAI: () => {
        const correct = State.currentQData.c[0];
        Notify.aiModal(State.currentQData.q, correct);
    },
    endSingle: (quit) => {
        clearInterval(State.timer);
        Notify.confirm(`Game Over! Score: ${State.score}`, () => Game.startSingle(State.mode), () => Nav.to('view-dashboard'));
    }
};

// --- MULTIPLAYER ---
const Multiplayer = {
    hostSelect: () => {
        if(!State.user) return Notify.toast("Login required", "error");
        Nav.to('view-host-lobby');
        State.lobbyId = Math.random().toString(36).substring(2,6).toUpperCase();
        document.getElementById('lobby-code-display').innerText = State.lobbyId;
        db.ref(`games/${State.lobbyId}`).set({
            host: State.user.displayName,
            status: 'waiting',
            players: { [State.user.uid]: State.user.displayName }
        });
        db.ref(`games/${State.lobbyId}/players`).on('value', snap => {
            const pList = document.getElementById('lobby-player-list');
            pList.innerHTML = '';
            snap.forEach(p => pList.innerHTML += `<div style="margin:5px;">${p.val()}</div>`);
        });
    },
    hostStartGame: () => {
        if(!State.lobbyId) return;
        db.ref(`games/${State.lobbyId}`).update({ status: 'started' });
        Notify.toast("Starting Game...", "success");
        if(!State.activeSet) { 
            db.ref('lookit_sets').limitToLast(1).once('value', snap => {
                const k = Object.keys(snap.val())[0];
                State.activeSet = { ...snap.val()[k], id: k };
                Game.startSingle(0);
            });
        } else {
            Game.startSingle(0);
        }
    },
    joinShow: () => document.getElementById('join-section').style.display = 'block',
    joinGame: () => {
        const code = document.getElementById('join-code').value.toUpperCase();
        if(!code) return;
        db.ref(`games/${code}`).once('value', snap => {
            if(snap.exists()) {
                db.ref(`games/${code}/players/${State.user.uid}`).set(State.user.displayName);
                Notify.toast("Joined! Waiting for host...", "success");
                db.ref(`games/${code}/status`).on('value', s => {
                    if(s.val() === 'started') {
                        db.ref('lookit_sets').limitToLast(1).once('value', snap => {
                            const k = Object.keys(snap.val())[0];
                            State.activeSet = { ...snap.val()[k], id: k };
                            Game.startSingle(0);
                        });
                    }
                });
            } else Notify.toast("Game not found", "error");
        });
    }
};

Auth.init();
</script>
</body>
</html>
</html>
</html>
